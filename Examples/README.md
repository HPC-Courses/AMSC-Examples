# Course on Advanced modeling for scientific computing #
## Mathematical Engineering, Politecnico di Milano ##
## Copyright Luca Formaggia##

## LICENCING ##
The software contained in the subfolders of this directory is free-software released under a GNU General Public Licens (GPL). The details of the licence are availabe in the `LICENCE` file in the root directory of the git repository holding this folder.


## CONTENT ##

Here you find the examples given in the course

`doc` -> Possible additional documentation

`lib` -> Possible libraries needed to compile some example

`include` -> General include files

`src` -> Directory with the example sources


## HOW TO COMPILE AND INSTALL THE EXAMPLES: THE FIRST STEP ##

To compile the examples the first operation to be made is to copy the
file `Makefile.user` to `Makefile.inc`:


    $ cp Makefile.user Makefile.inc


and edit the latter to suit your system.

(Almost) all `Makefiles` of the examples include the file `Makefile.inc` of this
directory and possibly a `Makefile.inc` file local to the example
under consideration.  You may modify those files to suit your need.

In particular, the user may modify the `Makefile.inc` to change some
compilation options. 

The main `Makefile.inc` also sets the `AMSC_ROOT` variable, which **should indicate the same directory where this** `README.md` **file is kept** (with the full path, i.e. the path should start with `/`).

**A  trick:**  on your terminal type `pwd` and copy/paste the result.!

As an example:

    AMSC_ROOT=/home/myname/AMSC-Examples/Examples/

Alternatively to editing the file, you may set an environmental
variable with the same name using the command 

    export AMSC_ROOT=/home/myname/AMSC-Examples/Examples/

in the `.profile` or in the `.bashrc` file in your home directory (see Note
at the end of the file). The file `Makefile.inc` is included in all the Makefiles and defines and
exports the following make macros:

- `PACS_ROOT` the directory where the Examples resides
- `CXX` the c++ compiler of choice
- `MPI_CC` how to compile MPI C code
- `MPI_CXX` how to compile MPI c++ code
- `MPI_RUN` how to run MPI code
- `STANDARD` contains the C++ standard used in compilation
- `MPI_LIBDIR` and `MPI_INCDIR` where to find mpi libraries and header files, respectively
- `TBB_LIBDIR` and `TBB_INCDIR`  where the threading building block libraries for c++ parallel ulitities are stored (libraries and header files).
- `EIGEN_DIR` The directory containing the headers of the eigen library for linear algebra
- `AMSC_INC_DIR` and `AMSC_LIB_DIR` directory for library and include files used by the examples, respectively
- `DOXYFILE` Location of the configuration file for DOxygen used in the examples
- `CPPFLAGS` Flags for the cpp preprocessor
- `CXXFLAGS` Flags for the c++ compiler
- `DEPEND` the file containing the autogenerated dependencies
- `LDFLAGS` Flags for the linker
- `LDLIBS` Common libraries (in the form `-Ldir -llib`)

Note that a local `Makefile.inc` may be contained (and included) in the
various directories when needed and it may override some of the macros
defined in the common `Makefile.inc`

I recall that any macro may be overruled by specifying it when calling make
Example:

    make CXXFLAGS+=-DSOMETHING LDFLAGS=SOMETHINGELSE

or by editing the corresponding `Makefile` (or, better, the `Makefile.inc`)

All examples are provided with a `Makefile` which accepts the following
options (some Makefile may have additional options, reported in the
`README.md` file specific for the example)

- `all` -makes the example
- `clean` -as it says
- `distclean` -clean and also deletes temporary file and local doc directory
- `doc` -creates directory doc and fills it with the documentation of the
example produced by doxygen. The file DoxiFileCommon contains the common 
doxygen configuration for all examples
- `lllibs` - makes static and dynamic library (whenever relevant)
- `install` -installs everithing in `AMSC_LIB_DIR` and `AMSC_INC_DIR`

Being `all` the first target of (almost all) the makefiles, to compile
the examples is often sufficient to type `make`. with `make doc` you
compile the documentation.


## WORKING WITH MODULES (but also if you do not use them...) ##

If you are using modules, some environmental variables are set by the
module system and will be inherited from the main `Makefile.inc` (the
one that you have created by copying Makefile.user).  In particular

- `mkEigenInc`    Where the Eigen libraries (infact the header files) is stored
- `mkOpenmpiLib`  The directory with the mpi libraries
- `mkOpenmpiInc`  The directory with the mpi headers
- `mkTbbInc`  Include files for the threding building block libraries (needed for parallel algorithms)
- `mkTbbLib`  Library files for the threading building block libraries (needed for parallel algorithms)
- `mkCxxCompiler` The c++ compiler of your choice
- `mkEigenHome`      Where the Eigen files are kept (normally equal to MkEigenInc)

Other important environment variables set up by the module system that may be 
not  used in `Makefile.user` but may be used by other makefiles of the examples are

- `mkClangSystemBin`  The directory holding all clang compiler executables 
- `mkCCompiler`       The C compiler of your choice
- `mkSuitesparseLib`  Directory holding the libraries of the suitesparse suite (umfpack for instance)
- `mkSuitesparseInc`  Directory holding the header files of the suitesparse suite (umfpack for instance)
- `mkCgalLib`         Directory with the CGAL libraries (computational geometry libraries)
- `mkCgalInc`         Directory with the CGAL header files
- `mkBoostInc`        Directory with the boost libraries     
- `mkBoostLib`        Directory with the boost header files


So, you have two main choices

  * You use the module system provided with the virtual machine. Then
in your `Makefile.inc` you have to set only `PACS_ROOT`, all other
variables are set by the module system.  I recall that if you want to
see all environmental variables set by the modules you may do (all
variables starts with `mk`):

-------------------------------------------------------------------------------

    env | grep mk 

-------------------------------------------------------------------------------

  * You do not use the module system. Then you have again two choices:
  
  1. You set the various macro in your `Makefile.inc` (and possibly the other Makefiles, if needed) by yourself
  2. You simulate the module environment by creating the environmental variables: you have to put in the `.profile `file in your home directory the corresponding instructions for the bash (the `~/.profile` file is read by the bash shell every time you do a login).  For example, in my `.profile` I have:

-------------------------------------------------------------------------------

    export mkSuitesparseInc=/usr/include/suitesparse/
    export mkSuitesparseLib=/usr/lib/x86_64-linux-gnu
    export mkCCompiler=gcc
    export mkCxxCompiler=g++
    export mkTbbInc=/usr/include
    export mkTbbLib=/usr/lib/x86_64-linux-gnu/
    export mkHdf5Inc=/usr/include/hdf5/serial/
    export mkEigenHome=/usr/local/include/eigen3
    export mkEigenInc=/usr/local/include/eigen3
    export mkBoostInc=/usr/local/boost_1_72_0/include
    export mkBoostLib=/usr/local/boost_1_72_0/lib
    export mkOpenmpiLib=/usr/lib/x86_64-linux-gnu
    export mkOpenmpiInc=/usr/include
    export mkCgalInc=/usr/include
    export mkCgalLib=/usr/lib/x86_64-linux-gnu


-------------------------------------------------------------------------------

Remember that after you have modified your .profile file you need to do a new login for the changes to be effective (see note at the end of the file)

## SECOND STEP: INSTALL UTILITIES ##

The examples require some common utilities that are contained in `src/Utilities/`. So it is simpler if we compile and install them once for all.

You must go to `src/Utilities` and do

    make
    make install


This way, a library called libamsc.a (and ist dynamic equivalent
libamsc.so) is installed in `AMSC_LIB_DIR` and some header files are
installed in `AMSC_INC_DIR`

If you then do `make test` you compile the programs that test the utilities. If everthing is fine compilation should complete with no errors. You may have al look at the tests and try to execute them.


**NOTE** Some examples show some native parallel programming of c++ that, at
least with gnu and LLVM compiler and INTEL hardware, requires the multithreading
building block (TBB) library installed, and to link to the `libtbb.so`
library. Check that the library is installed in your system (it's
available on all Linux distribution, but not necessarily by default!).

## FURTHER INFO ##

- An overview of the examples is in the `CONTENT.md` file
- The bash script `directories.sh` creates a searcheable
tree, `directory.html` of the subfolder `src` that may be parsed with
a browser. To run it you must have the unix utility `tree`
installed. Anyway, a copy of `directories.html` is present in this directory.

## The content of `src` Directory ##
A brief description of the examples in the `src` directory is four in `CONTENT.md`.


### A note on `.bashrc` or `.profile` (or `.bash_profile`) ### 

To control the settings of your Linux environment everytime you login
the (hidden) file `.bash_profile` (or `.profile` if you are using its
old, but still valid, name) in your home directory is sourced (its
content is run as if typed on a terminal). Everytime you open a bash
shell the `.bashrc` file is sourced. 

What's the difference? Well today people prefer to put everything in
the `.bashrc` file, but in principle envronmental variables
definitions should be put in the `.profile` (or `.bash_profile`),
while `.bashrc` should be reserved for command alias or customization
that need to change wether you are in a interactive shell (terminal)
or not (batch job). 

A practical difference is that if you change `.profile` (or `.bash_profile`)
the changes become operative only after a new login. 
Changes in `.bashrc` becomes active just by opening a new terminal.

If this is too confusing for you, replace `.profile` with `.bashrc` in
my instructions above and everithing will wark the same way in
practice.

If you want to know more (and discover that you have also
`.bash_login`) go
[here](https://www.baeldung.com/linux/bashrc-vs-bash-profile-vs-profile),
or look to any good Unix reference manual.

